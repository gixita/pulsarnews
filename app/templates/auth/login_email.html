{% extends "core.html" %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.1.1.js" crossorigin="anonymous"></script>
<script src="https://statics.teams.cdn.office.net/sdk/v1.6.0/js/MicrosoftTeams.min.js"  crossorigin="anonymous"></script>

<script type="text/javascript">
    microsoftTeams.initialize();
    // Login to Azure AD and get access to Microsoft Graph
    function login() {
        hideProfileAndError(); 
        microsoftTeams.authentication.authenticate({
            url: window.location.origin + "/auth/login_azure",
            width: 600,
            height: 535,
            successCallback: function (result) {
                console.log("Login succeeded: " + result);
                getUserProfile(result.accessToken);
            },
            failureCallback: function (reason) {
                console.log("Login failed: " + reason);
                handleAuthError(reason);
            }
        });
    }
    // Login to Azure AD and get access to Microsoft Graph
    function loginV2() {
        hideProfileAndError(); 
        microsoftTeams.authentication.authenticate({
            url: window.location.origin + "/auth/login_azurev2",
            width: 600,
            height: 535,
            successCallback: function (result) {
                console.log("Login succeeded: " + result);
                getUserProfile(result.accessToken);
            },
            failureCallback: function (reason) {
                console.log("Login failed: " + reason);
                handleAuthError(reason);
            }
        });
    }
    // Get the user's profile information from Microsoft Graph
    function getUserProfile(accessToken) {
        $.ajax({
            url: "https://graph.microsoft.com/v1.0/me/",
            beforeSend: function(request) {
                request.setRequestHeader("Authorization", "Bearer " + accessToken);
            },
            success: function (profile) {
                $("#profileDisplayName").text(profile.displayName);
                $("#profileJobTitle").text(profile.jobTitle);
                $("#profileMail").text(profile.mail);
                $("#profileUpn").text(profile.userPrincipalName);
                $("#profileObjectId").text(profile.id);
                $("#divProfile").css({ display: "" });
                $("#divError").css({ display: "none" });
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log("textStatus: " + textStatus + ", errorThrown:" + errorThrown);
                $("#divError").text(errorThrown).css({ display: "" });
                $("#divProfile").css({ display: "none" });
            },
        });
    }
    // Show error information
    function handleAuthError(reason) {
        $("#divError").text(reason).css({ display: "" });
        $("#divProfile").css({ display: "none" });
    }
    // Clear all information in tab
    function hideProfileAndError() {
        $("#divError").text("").css({ display: "none" });
        $("#divProfile").css({ display: "none" });
    }
</script>

<div class="container">
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh">
        <div class="text-center">
            <a href="{{ url_for('main.index', subdomain=subdomain) }}">
                <img
                class="mb-4"
                src="{{ url_for('static', filename='pulsarnews.png')}}"
                style="width: 250px;"
                />
            </a>
            <!-- <h5 class="mb-3">Connect</h5> -->
            <form action="" method="post" novalidate>
                {{ form.hidden_tag() }}
                <p>
                    {{ form.email(class="form-control form-control-lg", size=32, placeholder="Email") }}<br>
                    {% for error in form.email.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </p>
                <button class="btn btn-primary btn-lg" type="submit">Next</button>
            </form>
            <a href="{{ url_for('auth.register', subdomain=subdomain) }}">No account yet ?</a><br>
            <a href="{{ url_for('auth.login_azure', subdomain=subdomain) }}">Login with Azure</a><br>
            <input id = "Double Click here" type = "button" value = "clickme" onclick = "login();" />
            
            {% for arg in args %}
<p>{{ arg  }}</p>
{% endfor %}
        </div>
    </div>
</div>

{% endblock %}
